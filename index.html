<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QC Barcode - Scanner & G√©n√©rateur</title>
    <script src="https://unpkg.com/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f4f6f9; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Fen√™tre de scan am√©lior√©e */
        #video-container { 
            display: none; position: relative; width: 100%; height: 300px; 
            background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 15px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Guide de vis√©e (Rectangle rouge) */
        .scanner-laser {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; height: 40%;
            border: 2px solid red; border-radius: 4px;
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
            pointer-events: none;
        }

        .grid { display: flex; flex-direction: column; gap: 12px; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }
        label { display: block; font-weight: bold; font-size: 0.8em; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; }
        .btn-scan { background: var(--primary); }
        .btn-gen { background: var(--success); }
        .btn-stop { background: #d33; width: 100%; margin-bottom: 10px; display: none; }

        #output { margin-top: 20px; text-align: center; display: none; padding: 10px; border: 1px dashed #aaa; }
        canvas { max-width: 100%; height: auto; }
    </style>
</head>
<body>

<div class="container">
    <button id="btnStop" class="btn-stop" onclick="stopScan()">Annuler le scan</button>
    <div id="video-container">
        <video id="video"></video>
        <div class="scanner-laser"></div>
    </div>

    <div class="btn-group">
        <button class="btn-scan" onclick="startScan()">üì∑ Scanner Permis</button>
        <button class="btn-gen" onclick="generate()">‚öôÔ∏è G√©n√©rer</button>
    </div>

    <div class="grid">
        <div class="row">
            <div><label>Nom</label><input type="text" id="lastName"></div>
            <div><label>Pr√©nom</label><input type="text" id="firstName"></div>
        </div>
        <div class="row">
            <div><label>Naissance</label><input type="text" id="dob" placeholder="AAAAMMJJ"></div>
            <div><label>Sexe</label><select id="sex"><option value="1">M</option><option value="2">F</option></select></div>
        </div>
        <div><label>Num√©ro de Permis</label><input type="text" id="dlNum"></div>
        <div><label>Adresse</label><input type="text" id="address"></div>
        <div class="row">
            <div><label>Ville</label><input type="text" id="city"></div>
            <div><label>√âmission</label><input type="text" id="issueDate"></div>
        </div>
        <div class="row">
            <div><label>Expiration</label><input type="text" id="expiryDate"></div>
            <div><label>R√©f / DD</label><input type="text" id="dd"></div>
        </div>
    </div>

    <div id="output">
        <canvas id="barcodeCanvas"></canvas>
    </div>
</div>

<script>
    let codeReader = null;

    async function startScan() {
        const videoContainer = document.getElementById('video-container');
        const btnStop = document.getElementById('btnStop');
        videoContainer.style.display = 'block';
        btnStop.style.display = 'block';

        // Initialisation avec focus PDF417 uniquement
        codeReader = new ZXing.BrowserMultiFormatReader();
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.PDF_417]);
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true); // Mode lecture intense

        try {
            const videoDevices = await codeReader.listVideoInputDevices();
            // On cherche la cam√©ra arri√®re (back camera)
            const backCamera = videoDevices.find(device => device.label.toLowerCase().includes('back')) || videoDevices[videoDevices.length - 1];
            
            codeReader.decodeFromVideoDevice(backCamera.deviceId, 'video', (result, err) => {
                if (result) {
                    if (navigator.vibrate) navigator.vibrate(100); // Vibrer si scan r√©ussi
                    parseAAMVA(result.text);
                    stopScan();
                }
            });
        } catch (err) {
            console.error(err);
            alert("Erreur cam√©ra : " + err);
        }
    }

    function stopScan() {
        if(codeReader) codeReader.reset();
        document.getElementById('video-container').style.display = 'none';
        document.getElementById('btnStop').style.display = 'none';
    }

    function parseAAMVA(data) {
        const extract = (code) => {
            const regex = new RegExp(code + "(.*?)(?:\\n|\\r|$)", "i");
            const match = data.match(regex);
            return match ? match[1].trim() : "";
        };

        document.getElementById('lastName').value = extract('DCS');
        document.getElementById('firstName').value = extract('DAC');
        document.getElementById('dob').value = extract('DBB');
        document.getElementById('address').value = extract('DAG');
        document.getElementById('city').value = extract('DAI');
        document.getElementById('dlNum').value = extract('DAQ');
        document.getElementById('issueDate').value = extract('DBD');
        document.getElementById('expiryDate').value = extract('DBA');
        document.getElementById('dd').value = extract('DCF');
        
        const sex = extract('DBC');
        if(sex === "1" || sex === "M") document.getElementById('sex').value = "1";
        if(sex === "2" || sex === "F") document.getElementById('sex').value = "2";
    }

    function generate() {
        const LF = '\x0A'; const RS = '\x1E'; const CR = '\x0D';
        const getVal = (id) => document.getElementById(id).value.toUpperCase().trim();

        let dlData = "DL";
        dlData += `DCA5${LF}DCBNONE${LF}DCDNONE${LF}`;
        dlData += `DBA${getVal('expiryDate')}${LF}DCS${getVal('lastName')}${LF}DAC${getVal('firstName')}${LF}`;
        dlData += `DBD${getVal('issueDate')}${LF}DBB${getVal('dob')}${LF}DBC${getVal('sex')}${LF}`;
        dlData += `DAU182 cm${LF}DAG${getVal('address')}${LF}DAI${getVal('city')}${LF}DAJQC${LF}`;
        dlData += `DAQ${getVal('dlNum')}${LF}DCF${getVal('dd')}${LF}`;
        dlData += `DCGCAN${LF}DDEU${LF}DDFU${LF}DDGU${LF}`;

        let zqData = `ZQZQAPC${LF}BS1P03E458-01${LF}`;

        const headerStatic = `@${LF}${RS}${CR}ANSI 604428100002`;
        const headerLen = headerStatic.length + 20;
        const dlOffset = headerLen.toString().padStart(4, '0');
        const dlLen = dlData.length.toString().padStart(4, '0');
        const zqOffset = (headerLen + dlData.length).toString().padStart(4, '0');
        const zqLen = zqData.length.toString().padStart(4, '0');

        const fullData = `${headerStatic}DL${dlOffset}${dlLen}ZQ${zqOffset}${zqLen}${dlData}${zqData}`;

        try {
            document.getElementById('output').style.display = 'block';
            bwipjs.toCanvas('barcodeCanvas', {
                bcid: 'pdf417', text: fullData, scale: 3, height: 10, cols: 9, eclevel: 5
            });
        } catch (e) { alert(e); }
    }
</script>
</body>
</html>
